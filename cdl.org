#+TITLE:     Cropland Data Layer
#+AUTHOR:    Neil Best
#+EMAIL:     nbest@ci.uchicago.edu
#+DATE:      2012-05-04 Fri
#+DESCRIPTION:
#+KEYWORDS:
#+LANGUAGE:  en
#+OPTIONS:   H:3 num:t toc:t \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc
#+INFOJS_OPT: view:nil toc:nil ltoc:t mouse:underline buttons:0 path:http://orgmode.org/org-info.js
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport
#+LINK_UP:   
#+LINK_HOME: 
#+XSLT:

#+PROPERTY: session *R*

* test the samples from the CropScape Developer Guide

[[http://nassgeodata.gmu.edu/CropScape/devhelp/help.html]]

[[http://nassgeodata.gmu.edu:8080/axis2/services/CDLService/GetCDLFile?year=2009&fips=19015]]

#+begin_src R
  library( RCurl)
  library( XML)
  library( raster)
  
  queryUrl <- "http://nassgeodata.gmu.edu:8080/axis2/services/CDLService/GetCDLFile?year=2009&fips=19015"
  
  fileUrl <-
    xpathSApply( xmlInternalTreeParse( getURL( queryUrl)),
                "//returnURL", fun= xmlValue, simplify= TRUE)
  
  fn <- basename( fileUrl)
  
  download.file( fileUrl, fn, mode= "wb")
  
  r <- raster( fn)
  
  NAvalue( r)
  
  GDALinfo( fn)
#+end_src

* create the list of county FIPS codes

#+begin_src R
  library( foreign)
  library( foreach)
  library( doMC)
  
  registerDoMC()
  
  tiger <- read.dbf( "tiger/tl_2011_us_county.dbf")
  
  cdlFips <- tiger[ !str_detect( tiger$STATEFP, "^(02|15|6.|7.)"),
               c( "STATEFP", "COUNTYFP")]
  
  cdlFips <- sort( with( cdlFips, paste( STATEFP, COUNTYFP, sep= "")))
  names( cdlFips) <- cdlFips 
#+end_src

* define a function that downloads the data by year, county FIPS

#+begin_src R
  library( RCurl)
  library( XML)
  
  downloadCdlCounty <- function( fips= "19015", year= "2009", overwrite= FALSE) {
    queryUrlFormat <- "http://nassgeodata.gmu.edu:8080/axis2/services/CDLService/GetCDLFile?year=%s&fips=%s"
    queryUrl <- sprintf( queryUrlFormat, year, fips)
    queryXml <- getURL( queryUrl)
    fileUrl <-
      xpathSApply( xmlInternalTreeParse( queryXml),
                  "//returnURL", fun= xmlValue, simplify= TRUE)
    list( queryXml,
          try( silent= TRUE,
            {
              fn <- sprintf( "tif/%s", basename( fileUrl))
              if( !file.exists( fn) || overwrite) {
                download.file( fileUrl, fn, mode= "wb", quiet= TRUE)
              }
              fn
            } )
         )
  }
  
  cdl2008 <- llply(  cdlFips, downloadCdlCounty, year="2008", .parallel= TRUE)
  cdl2006 <- llply( cdlFips, downloadCdlCounty, year="2006", .parallel= TRUE)
  
#+end_src

The CDL web service seems to have triansient failures such that not
all data downloads succeed on the first attempt.  There should be 1270
files for 2006 and 3109 files for 2008.

** TODO write a test that indicates whether all data appeared

* write out the frequency tables for each county

#+begin_src R
  cdlTifs <- list.files( "tif", patt= "^CDL.*tif$", full.names= TRUE)
  
  writeFreqCsv <- function( tif) {
    r <- raster( tif)
    freqCsv <- sprintf( "freq/%s",
                       str_replace( basename( filename( r)),
                                   "tif", "csv"))
    write.csv( freq( r), file= freqCsv, row.names= FALSE)
    freqCsv
  }
  
  freqCsvs <- llply( cdlTifs, writeFreqCsv, .parallel= TRUE)
#+end_src

* parse the metadata for crop labels

#+begin_src R
  library( XML)
  
  cdlMeta <-
    xpathSApply( xmlInternalTreeParse( "metadata/cdlmeta_56m_r_ar_2008.xml"),
                "//eadetcit", fun= xmlValue, simplify= TRUE)
  
  cdlMeta <- unlist( str_split( cdlMeta, "\\n"))
  
  pattern <- "^>[[:space:]]+\"([0-9]+)\"[[:space:]]+(.*)$"
  
  cdlMeta <-
    data.frame( do.call( rbind,
                        str_match_all( cdlMeta, pattern))[, c( 2, 3)],
               stringsAsFactors= FALSE)
  
  
#+end_src

* aggregate and cross-tabulate hectares by state and county

#+begin_src R
  library( reshape2)
  
  freqFiles <- list.files( "freq", full.names= TRUE)
  
  freqRegex <- "^freq/CDL_([0-9]{4})_([0-9]{2})([0-9]{3})\\.csv"
  freqMeta <- str_match( freqFiles, freqRegex)
  
  
  
  loadFreqFile <- function( freqMeta) {
    freqDf <- read.csv( freqMeta[ 1],
                       col.names= c( "cdl", "n"))
    within( freqDf, {
      year <- freqMeta[ 2]
      stfips <- freqMeta[ 3]
      cofips <- freqMeta[ 4]})
  }
  
  simpleLevels <- c( "Corn", "Soybeans", "Alfalfa",
                    "Other Hay/Non Alfalfa", "Switchgrass",
                    "Pasture/Grass", "Pasture/Hay",
                    "Fallow/Idle Cropland", "Dbl Crop Corn/Soybeans",
                    "Dbl Crop Corn/Other", "Dbl Crop Soybeans/Other",
                    "Wheat", "Other Crops", "Other")
  
  nonCropLevels <- c( "Clouds/No Data", "Developed", "Water",
                     "Wetlands", "Nonag/Undefined", "Aquaculture",
                     "Open Water", "Perennial Ice/Snow",
                     "Developed/Open Space", "Developed/Low Intensity",
                     "Developed/Med Intensity",
                     "Developed/High Intensity", "Barren",
                     "Deciduous Forest", "Evergreen Forest",
                     "Mixed Forest", "Shrubland",
                     "Grassland Herbaceous", "Pasture/Hay",
                     "Woody Wetlands", "Herbaceous Wetlands")
  
  dblCornOtherPatt <- "^Dbl Crop (Oats|Barley|WinWht)/Corn"
  dblSoyOtherPatt <- "^Dbl Crop (Soybeans/(Cotton|Oats)|(WinWht|Barley)/Soybeans)"
  
  freqDf <- adply( freqMeta, 1, loadFreqFile, .parallel= TRUE)[, -1]
  
  within( freqDf[ !is.na( freqDf$cdl), ], {
    browser()
  })
  
  freqDf <- within( freqDf[ !is.na( freqDf$cdl), ], {
    cdl <- factor( cdl)
    levels( cdl) <- c( levels( cdl), "254")
    levels( cdl) <- cdlMeta[ -1, 2]
    simple <- factor( rep( "Other Crops", length( cdl)),
                     levels= simpleLevels)
    sameAsCdl <- as.character( cdl) %in% simpleLevels[ 1:9]
    dblCornOther <- str_detect( cdl, dblCornOtherPatt)
    dblSoyOther <- str_detect( cdl, dblSoyOtherPatt)
    wheat <- cdl %in% c( "Durum Wheat", "Spring Wheat", "Winter Wheat")
    nonCrop <- as.character( cdl) %in% nonCropLevels
    simple[ sameAsCdl] <- as.character( cdl[ sameAsCdl])
    simple[ dblCornOther] <- "Dbl Crop Corn/Other"
    simple[ dblSoyOther] <- "Dbl Crop Soybeans/Other"
    simple[ wheat] <- "Wheat"
    simple[ nonCrop] <- "Other"
    rm( sameAsCdl, dblCornOther, dblSoyOther, wheat, nonCrop)
    ha <- round( n *56^2 /10^4)
  })
  
  freqCt <- cast( freqDf, stfips + year ~ simple, value= "n", fun.aggregate= sum)
  
  areaStateCt <- dcast( freqDf, year + stfips ~ simple,
                      value.var= "ha",
                      fun.aggregate= sum,
                      margins= c( "stfips", "simple"))
  write.csv( areaStateCt, "cdlStateSimple.csv", row.names= FALSE)
  
  areaCountyCt <- dcast( freqDf, year + stfips + cofips ~ simple,
                       value.var= "ha",
                       fun.aggregate= sum,
                       margins= c( "stfips", "cofips", "simple"))
  write.csv( areaCountyCt, "cdlCountySimple.csv", row.names= FALSE)
  
  zip( "cdlSimple.zip", list.files( patt= "^cdl(County|State)Simple.csv"))
#+end_src
